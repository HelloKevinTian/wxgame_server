var mongo = require('mongoskin');
var logger = require('ss-logger').getLogger(__filename);
var uuid = require('uuid');
var fs = require('fs');

var _db = {};
var uidTable = 'GlobleGuid';

/**
 * 获取db对象.
 *
 * @return {db Object}
 */
function getDB(table) {
    if (!table) {
        table = 'game';
    }

    return _db[table];
};

/**
 * 配置mongodb模块.
 *
 * @param  {String|Object} config 配置文件路径或者配置文件对象
 * @return {void}
 */
function configure(config) {
    if (typeof config === 'string') {
        config = JSON.parse(fs.readFileSync(config, "utf8"));
    };

    var dbOptions = {
        native_parser: true
    };

    for (var i in config) {
        var db = config[i];
        if (db.host == null || db.port == null || db.db == null) {
            continue;
        }

        var dbName = ('mongodb://' + db.host + ':' + db.port + '/' + db.db + '?auto_reconnect=true');
        _db[i] = mongo.db(dbName, dbOptions);
        if (_db[i] == null) {
            logger.error('create db %s fail');
        }
    }
};



/*
 * 导出函数列表
 */
module.exports = {
    // 配置mongodb
    'configure': configure,
    // 获取db对象
    'db': getDB
};
